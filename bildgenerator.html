<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BYT IMG MAKER</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: monospace;
      background-color: #0a0a0a;
      color: #00ff99;
    }
    textarea {
      resize: none;
    }
    .neon-text {
      text-shadow: 0 0 8px #00ff99, 0 0 16px #00ff99;
    }
    .glitch {
      color: #fff;
      position: relative;
    }
    .glitch::before, .glitch::after {
      content: attr(data-text);
      position: absolute;
      left: 0;
      width: 100%;
      overflow: hidden;
      clip: rect(0, 900px, 0, 0);
    }
    .glitch::before {
      animation: glitchTop 2s infinite linear alternate-reverse;
      color: #ff00ff;
    }
    .glitch::after {
      animation: glitchBottom 1.5s infinite linear alternate-reverse;
      color: #00ffff;
    }
    @keyframes glitchTop {
      0% { clip: rect(0, 9999px, 0, 0); }
      20% { clip: rect(0, 9999px, 20px, 0); }
      40% { clip: rect(0, 9999px, 10px, 0); }
      60% { clip: rect(0, 9999px, 25px, 0); }
      80% { clip: rect(0, 9999px, 15px, 0); }
      100% { clip: rect(0, 9999px, 0, 0); }
    }
    @keyframes glitchBottom {
      0% { clip: rect(0, 9999px, 0, 0); }
      20% { clip: rect(5px, 9999px, 25px, 0); }
      40% { clip: rect(15px, 9999px, 40px, 0); }
      60% { clip: rect(10px, 9999px, 35px, 0); }
      80% { clip: rect(20px, 9999px, 45px, 0); }
      100% { clip: rect(0, 9999px, 0, 0); }
    }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">
  <div class="bg-black/70 p-6 md:p-10 rounded-2xl border border-green-500 w-full max-w-2xl text-center flex flex-col gap-5 shadow-[0_0_20px_#00ff99]">
    
    <h1 class="text-3xl md:text-4xl font-bold neon-text glitch" data-text="BYT IMG MAKER">BYT IMG MAKER</h1>
    <p class="text-green-400">MADE BY BYT // POWERED BY GEMINI</p>

    <textarea
      id="promptInput"
      class="w-full h-32 p-4 bg-black border border-green-500 rounded-lg text-green-200 placeholder-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 transition-all duration-200"
      placeholder="> Gib deine Beschreibung ein..."
    ></textarea>    

    <button
      id="generateButton"
      class="bg-green-600 text-black font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-green-700 active:bg-green-800 transition-all duration-200 transform hover:scale-105 disabled:bg-gray-800 disabled:text-gray-500"
    >
      > Bild generieren
    </button>

    <div id="loadingIndicator" class="hidden text-green-400 font-medium text-lg">
      [*] Dein Bild wird generiert... bitte warten.
    </div>

    <div id="imageContainer" class="mt-4 flex justify-center bg-black/60 p-2 rounded-lg min-h-[256px] items-center border border-green-700">
      <p class="text-green-600">> BYT SYSTEM READY</p>
    </div>
  </div>

  <script>
    const apiKey = "AIzaSyC8KiRFG4Q-sbNZyZlVtzz-fB6_SwZ7g9I"; // HIER DEIN GEMINI API KEY
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/imagen-3.0-generate-002:predict?key=${apiKey}`;

    const promptInput = document.getElementById('promptInput');
    const generateButton = document.getElementById('generateButton');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const imageContainer = document.getElementById('imageContainer');

    // ðŸ”’ Speichern der Eingabe in LocalStorage
    promptInput.addEventListener("input", () => {
      localStorage.setItem("promptText", promptInput.value);
    });

    // ðŸ”“ Wiederherstellen beim Laden
    window.addEventListener("load", () => {
      const savedPrompt = localStorage.getItem("promptText");
      if (savedPrompt) {
        promptInput.value = savedPrompt;
      }
    });

    async function fetchWithExponentialBackoff(url, options, maxRetries = 5, delay = 1000) {
      for (let i = 0; i < maxRetries; i++) {
        try {
          const response = await fetch(url, options);
          if (response.status === 429 && i < maxRetries - 1) {
            console.warn(`Anfrage gedrosselt. Versuch ${i + 1}/${maxRetries}. Neuer Versuch in ${delay / 1000}s...`);
            await new Promise(resolve => setTimeout(resolve, delay));
            delay *= 2;
            continue;
          }
          return response;
        } catch (error) {
          if (i < maxRetries - 1) {
            console.error(`Fehler Versuch ${i + 1}/${maxRetries}:`, error);
            await new Promise(resolve => setTimeout(resolve, delay));
            delay *= 2;
            continue;
          }
          throw error;
        }
      }
    }

    generateButton.addEventListener('click', async () => {
      const userPrompt = promptInput.value.trim();
      if (!userPrompt) {
        imageContainer.innerHTML = '<p class="text-red-500 font-bold">[!] Bitte gib eine Bildbeschreibung ein.</p>';
        return;
      }
      generateButton.disabled = true;
      generateButton.innerHTML = '> Generating...';
      loadingIndicator.classList.remove('hidden');
      imageContainer.innerHTML = '';

      try {
        const payload = {
          instances: [{ prompt: userPrompt }],
          parameters: { "sampleCount": 1 }
        };
        const options = {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        };
        const response = await fetchWithExponentialBackoff(apiUrl, options);
        const result = await response.json();

        if (result.predictions && result.predictions.length > 0 && result.predictions[0].bytesBase64Encoded) {
          const base64Data = result.predictions[0].bytesBase64Encoded;
          const imageUrl = `data:image/png;base64,${base64Data}`;
          const img = document.createElement('img');
          img.src = imageUrl;
          img.alt = userPrompt;
          img.classList.add('max-w-full', 'h-auto', 'rounded-xl', 'shadow-lg');
          imageContainer.innerHTML = '';
          imageContainer.appendChild(img);
        } else {
          imageContainer.innerHTML = '<p class="text-red-500">[!] Fehler beim Generieren. Retry.</p>';
          console.error('API-Response unerwartet:', result);
        }
      } catch (error) {
        console.error('API Fehler:', error);
        imageContainer.innerHTML = '<p class="text-red-500">[!] Unerwarteter Fehler. Check Input.</p>';
      } finally {
        generateButton.disabled = false;
        generateButton.innerHTML = '> Bild generieren';
        loadingIndicator.classList.add('hidden');
      }
    });
  </script>
</body>
</html>
